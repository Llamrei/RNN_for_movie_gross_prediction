#!/bin/bash

# Debug queue:
# PBS -l select=1:ncpus=8:mem=24gb:ompthreads=8
# PBS -l walltime=00:30:0
# PBS -J 1-36

# Throughput queue:
#PBS -l select=1:ncpus=8:mem=24gb:ompthreads=8
#PBS -l walltime=00:31:0
#PBS -J 1-36

# GPU queue:
# PBS -lselect=1:ncpus=4:mem=24gb:ngpus=1:gpu_type=RTX6000
# PBS -l walltime=10:00:0
# PBS -J 1-


echo "Started"
date

inter_threads=2
intra_threads=6
job="${PBS_JOBID%[*}"

# Debug single:
# exp_vals=(mse-tfidf-shallow_wide-wd)
# Quick CPU permute:
exp_vals=({'mse','mae','mape'}-tfidf-{'core','shallow_wide','deep_narrow','deep_wide'}-{'l1','l2','do'})
# Long GPU permute:
# exp_vals=(mae-{'learned','bert'}-{'core','shallow_wide','deep_narrow','deep_wide'}-{'l1','l2','do'})


if [ -z "$PBS_ARRAY_INDEX" ]; then
    no_exps="${#exp_vals[@]}"
    array_idx=$(($PBS_ARRAY_INDEX - 1))

    # For repeating experiments we want to cycle through our experiment values
    # Important fact here is the same array index will give you the same experimental value
    # so if we repeat an experiment multiple times it will always go to the same folder
    exp_idx=$(($array_idx % $no_exps))
    exp_val=${exp_vals[$exp_idx]}

    exp_counter=$(($array_idx / $no_exps))
    save_dir="$exp_val/$exp_counter/"
else
    exp_val=${exp_vals[0]}
fi


input_data_path="$HOME/RNN_for_movie_gross_prediction/complete10000_films_and_synopsis.pickle"
script_dir="$HOME/RNN_for_movie_gross_prediction/jobs/mini_project_exps/"
output_dir="$EPHEMERAL/mini_project_exps/$PBS_JOBNAME/$save_dir"

mkdir -p $output_dir
# Just so we can remember which job made this
touch "$output_dir/$job.txt"
cd $script_dir

module load anaconda3/personal
module load cuda
source activate tf2-w-text
python experiment.py "$output_dir" "$input_data_path" "$exp_val" "$intra_threads" "$inter_threads" &>"$output_dir/stdout"

echo "Done"
date